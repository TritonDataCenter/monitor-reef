name: CI

on:
  push:
    branches: [ main, clean-history-round-two ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # 5.0.1
        with:
          fetch-depth: 0

      - name: Install Rust 1.90 with components
        uses: dtolnay/rust-toolchain@0f44b27771c32bda9f458f75a1e241b09791b331 # 1.91.1
        with:
          toolchain: 1.90
          components: clippy, rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # 2.8.1

      - name: Show rustc/cargo versions
        run: |
          rustc -V
          cargo -V

      - name: Set up Git refs for OpenAPI comparison
        run: |
          git fetch --no-tags origin main
          git checkout -b ci-branch

      - name: Check (fmt, clippy, tests, openapi-check)
        run: |
          make check

  coverage:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # 5.0.1

      - name: Install Rust 1.90
        uses: dtolnay/rust-toolchain@0f44b27771c32bda9f458f75a1e241b09791b331 # 1.91.1
        with:
          toolchain: 1.90

      - name: Cache cargo (coverage namespace)
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # 2.8.1
        with:
          prefix-key: coverage

      - name: Cache cargo-tarpaulin binary
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: ~/.cargo/bin/cargo-tarpaulin
          key: cargo-tarpaulin-${{ runner.os }}

      - name: Run coverage check
        run: |
          make coverage
